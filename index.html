<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Accounting Dashboard - Freelance Music Production</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e4e4e4;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #a0a0a0;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card h3 {
            font-size: 0.9em;
            color: #a0a0a0;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #fff;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e4e4e4;
            cursor: pointer;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
            color: #fff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
            color: #a0a0a0;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .current-month {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            position: relative;
        }

        .current-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-critical { background-color: #ff4444; }
        .status-warning { background-color: #ffaa00; }
        .status-safe { background-color: #00ff00; }
        .status-excellent {
            background-color: #00ff00;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 10px #00ff00; }
            50% { opacity: 0.6; box-shadow: 0 0 20px #00ff00; }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #a0a0a0;
            font-weight: 500;
        }

        input, select, textarea {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-size: 1em;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
        }

        .entry-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .entry-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .entry-amount {
            font-size: 1.3em;
            font-weight: bold;
        }

        .entry-details {
            font-size: 0.9em;
            color: #a0a0a0;
        }

        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .tax-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .tax-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tax-card h3 {
            font-size: 0.9em;
            color: #a0a0a0;
            margin-bottom: 10px;
        }

        .tax-card .amount {
            font-size: 1.8em;
            font-weight: bold;
        }

        .positive {
            color: #00ff00;
        }

        .negative {
            color: #ff4444;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .table-scroll {
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .stat-card .value {
                font-size: 1.5em;
            }

            table {
                font-size: 0.85em;
            }

            th, td {
                padding: 8px 5px;
            }
        }

        .receipt-link {
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.85em;
        }

        input[type="file"] {
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíº Master Accounting Dashboard</h1>
        <p class="subtitle" id="subtitleText">Freelance Music Production Business | Safety Threshold: ¬£20,000</p>

        <!-- Quick Stats -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <h3>Current Balance</h3>
                <div class="value" id="currentBalance">¬£0.00</div>
            </div>
            <div class="stat-card">
                <h3>This Month Income</h3>
                <div class="value" id="monthIncome">¬£0.00</div>
            </div>
            <div class="stat-card">
                <h3>YTD Total Income</h3>
                <div class="value" id="ytdIncome">¬£0.00</div>
            </div>
            <div class="stat-card">
                <h3>Tax Set Aside (20%)</h3>
                <div class="value" id="taxReserve">¬£0.00</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab(event, 'overview')">üìä Overview</button>
            <button class="tab-btn" onclick="switchTab(event, 'income')">üí∞ Income</button>
            <button class="tab-btn" onclick="switchTab(event, 'expenses')">üí≥ Expenses</button>
            <button class="tab-btn" onclick="switchTab(event, 'tax')">üìã Tax Dashboard</button>
            <button class="tab-btn" onclick="switchTab(event, 'settings')">‚öôÔ∏è Settings</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="section">
                <h2>Monthly Overview</h2>
                <div class="table-scroll">
                    <table id="monthlyTable">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Opening Balance</th>
                                <th>Total Income</th>
                                <th>Living Costs</th>
                                <th>Other Expenses</th>
                                <th>Net Change</th>
                                <th>Closing Balance</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Income Tab -->
        <div id="income" class="tab-content">
            <div class="section">
                <h2>Add Income Entry</h2>
                <form id="incomeForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="incomeDate" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" id="incomeDescription" placeholder="e.g., Ghost Production Track" required>
                        </div>
                        <div class="form-group">
                            <label>Gross Amount (¬£)</label>
                            <input type="number" id="incomeAmount" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label>Source</label>
                            <select id="incomeSource">
                                <option>Ghost Production</option>
                                <option>Fiverr Gig</option>
                                <option>Sample Pack Sale</option>
                                <option>Podcast Licensing</option>
                                <option>DJ Service</option>
                                <option>Custom Beat</option>
                                <option>Meditation Music</option>
                                <option>Other</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit">Add Income</button>
                </form>

                <p style="margin-top:15px;font-size:0.9em;color:#a0a0a0;">
                    This month income total: <strong id="incomeMonthTotal">¬£0.00</strong>
                </p>

                <div class="entry-list" id="incomeList">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content">
            <div class="section">
                <h2>Add Expense Entry</h2>
                <form id="expenseForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="expenseDate" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" id="expenseDescription" placeholder="e.g., Native Instruments Plugin" required>
                        </div>
                        <div class="form-group">
                            <label>Amount (¬£)</label>
                            <input type="number" id="expenseAmount" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="expenseCategory">
                                <option>Equipment</option>
                                <option>Software</option>
                                <option>Marketing</option>
                                <option>Living</option>
                                <option>Office</option>
                                <option>Professional Fees</option>
                                <option>Travel</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Receipt (optional)</label>
                            <input type="file" id="expenseReceipt" accept="image/*,.pdf">
                        </div>
                    </div>
                    <button type="submit">Add Expense</button>
                </form>

                <p style="margin-top:15px;font-size:0.9em;color:#a0a0a0;">
                    This month expenses total (excl. fixed living): <strong id="expenseMonthTotal">¬£0.00</strong>
                </p>

                <div class="entry-list" id="expenseList">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Tax Dashboard Tab -->
        <div id="tax" class="tab-content">
            <div class="section">
                <h2>Tax Year 2025/2026 (6 April 2025 - 5 April 2026)</h2>
                <div class="tax-grid">
                    <div class="tax-card">
                        <h3>Total Income (YTD)</h3>
                        <div class="amount" id="taxTotalIncome">¬£0.00</div>
                    </div>
                    <div class="tax-card">
                        <h3>Deductible Expenses (YTD)</h3>
                        <div class="amount" id="taxTotalExpenses">¬£0.00</div>
                    </div>
                    <div class="tax-card">
                        <h3>Taxable Profit</h3>
                        <div class="amount" id="taxableProfit">¬£0.00</div>
                    </div>
                    <div class="tax-card">
                        <h3>Estimated Tax Owed</h3>
                        <div class="amount negative" id="estimatedTax">¬£0.00</div>
                    </div>
                    <div class="tax-card">
                        <h3>Tax Already Set Aside (20%)</h3>
                        <div class="amount positive" id="taxSetAside">¬£0.00</div>
                    </div>
                    <div class="tax-card">
                        <h3>Tax Fund Surplus/Shortfall</h3>
                        <div class="amount" id="taxDifference">¬£0.00</div>
                    </div>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <h3 style="margin-bottom: 15px;">UK Tax Bands 2025/2026</h3>
                    <table>
                        <tr>
                            <th>Band</th>
                            <th>Income Range</th>
                            <th>Rate</th>
                        </tr>
                        <tr>
                            <td>Personal Allowance</td>
                            <td>¬£0 - ¬£12,570</td>
                            <td>0%</td>
                        </tr>
                        <tr>
                            <td>Basic Rate</td>
                            <td>¬£12,571 - ¬£50,270</td>
                            <td>20%</td>
                        </tr>
                        <tr>
                            <td>Higher Rate</td>
                            <td>¬£50,271 - ¬£125,140</td>
                            <td>40%</td>
                        </tr>
                        <tr>
                            <td>Additional Rate</td>
                            <td>¬£125,140+</td>
                            <td>45%</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="section">
                <h2>Data Management</h2>
                <div class="action-buttons">
                    <button onclick="exportData()">üì• Export Data (JSON)</button>
                    <button onclick="exportCSV()">üìä Export CSV for Accountant</button>
                    <button onclick="document.getElementById('importFile').click()" class="btn-secondary">üì§ Import Data</button>
                    <button onclick="clearAllData()" class="btn-danger">üóëÔ∏è Clear All Data</button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>

            <div class="section">
                <h2>Business Parameters</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Safety Threshold (¬£)</label>
                        <input type="number" id="safetyThreshold" value="20000" step="100">
                    </div>
                    <div class="form-group">
                        <label>Monthly Living Costs (¬£)</label>
                        <input type="number" id="livingCosts" value="2700" step="50">
                    </div>
                    <div class="form-group">
                        <label>Tax Rate (%)</label>
                        <input type="number" id="taxRate" value="20" step="1" min="0" max="100">
                    </div>
                </div>
                <button onclick="saveSettings()" style="margin-top: 15px;">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        // Core data structure
        let data = {
            settings: {
                safetyThreshold: 20000,
                livingCosts: 2700,
                taxRate: 20,
                startingBalance: 28248,
                startMonth: '2025-09' // YYYY-MM, 12 months forward
            },
            income: [],
            expenses: []
        };

        // Initialize everything
        function init() {
            loadData();
            setDefaultDates();
            renderMonthlyTable();
            renderIncome();
            renderExpenses();
            updateDashboard();
            updateTaxDashboard();
        }

        function loadData() {
            const saved = localStorage.getItem('accountingData');
            if (saved) {
                try {
                    data = JSON.parse(saved);
                } catch (e) {
                    console.error('Error parsing saved data, resetting.', e);
                }
            }

            // Load settings into UI
            if (data.settings) {
                document.getElementById('safetyThreshold').value = data.settings.safetyThreshold || 20000;
                document.getElementById('livingCosts').value = data.settings.livingCosts || 2700;
                document.getElementById('taxRate').value = data.settings.taxRate || 20;
                document.getElementById('subtitleText').textContent =
                    `Freelance Music Production Business | Safety Threshold: ¬£${(data.settings.safetyThreshold || 20000).toLocaleString()}`;
            }
        }

        function saveData() {
            localStorage.setItem('accountingData', JSON.stringify(data));
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const incomeDate = document.getElementById('incomeDate');
            const expenseDate = document.getElementById('expenseDate');
            if (incomeDate) incomeDate.value = today;
            if (expenseDate) expenseDate.value = today;
        }

        // Generate 12 months from startMonth
        function generateMonths() {
            const months = [];
            const startDate = new Date(data.settings.startMonth + '-01');

            for (let i = 0; i < 12; i++) {
                const monthDate = new Date(startDate);
                monthDate.setMonth(startDate.getMonth() + i);
                months.push({
                    date: monthDate.toISOString().slice(0, 7),
                    label: monthDate.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' })
                });
            }

            return months;
        }

        // Calculate monthly projection + actuals
        function calculateMonthlyData() {
            const months = generateMonths();
            const monthlyData = [];
            let runningBalance = data.settings.startingBalance;

            months.forEach(month => {
                const monthIncome = data.income
                    .filter(inc => inc.date.startsWith(month.date))
                    .reduce((sum, inc) => sum + parseFloat(inc.amount), 0);

                const monthExpenses = data.expenses
                    .filter(exp => exp.date.startsWith(month.date))
                    .reduce((sum, exp) => sum + parseFloat(exp.amount), 0);

                const openingBalance = runningBalance;
                const netChange = monthIncome - data.settings.livingCosts - monthExpenses;
                const closingBalance = openingBalance + netChange;

                monthlyData.push({
                    month: month.label,
                    date: month.date,
                    openingBalance,
                    income: monthIncome,
                    livingCosts: data.settings.livingCosts,
                    expenses: monthExpenses,
                    netChange,
                    closingBalance
                });

                runningBalance = closingBalance;
            });

            return monthlyData;
        }

        // Status helpers (fixed thresholds as specified)
        function getStatusClass(balance) {
            if (balance < 18000) return 'status-critical';
            if (balance >= 18000 && balance <= 20000) return 'status-warning';
            if (balance > 20000 && balance <= 30000) return 'status-safe';
            return 'status-excellent';
        }

        function getStatusText(balance) {
            if (balance < 18000) return 'CRITICAL';
            if (balance >= 18000 && balance <= 20000) return 'WARNING';
            if (balance > 20000 && balance <= 30000) return 'SAFE';
            return 'EXCELLENT';
        }

        // Render monthly overview table
        function renderMonthlyTable() {
            const monthlyData = calculateMonthlyData();
            const tbody = document.getElementById('monthlyTableBody');
            const today = new Date().toISOString().slice(0, 7);

            tbody.innerHTML = monthlyData.map(month => {
                const isCurrent = month.date === today;
                const statusClass = getStatusClass(month.closingBalance);
                const statusText = getStatusText(month.closingBalance);

                return `
                    <tr class="${isCurrent ? 'current-month' : ''}">
                        <td>
                            ${month.month}
                            ${isCurrent ? '<span class="current-badge">CURRENT</span>' : ''}
                        </td>
                        <td>¬£${month.openingBalance.toFixed(2)}</td>
                        <td>¬£${month.income.toFixed(2)}</td>
                        <td>¬£${month.livingCosts.toFixed(2)}</td>
                        <td>¬£${month.expenses.toFixed(2)}</td>
                        <td style="color: ${month.netChange >= 0 ? '#00ff00' : '#ff4444'}">
                            ¬£${month.netChange.toFixed(2)}
                        </td>
                        <td>¬£${month.closingBalance.toFixed(2)}</td>
                        <td>
                            <span class="status-indicator ${statusClass}"></span>
                            ${statusText}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Income form submission
        document.getElementById('incomeForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const amount = parseFloat(document.getElementById('incomeAmount').value);

            const income = {
                id: Date.now(),
                date: document.getElementById('incomeDate').value,
                description: document.getElementById('incomeDescription').value,
                amount: amount,
                source: document.getElementById('incomeSource').value,
                tax: amount * (data.settings.taxRate / 100),
                net: amount * (1 - data.settings.taxRate / 100)
            };

            data.income.push(income);
            saveData();

            e.target.reset();
            setDefaultDates();
            renderIncome();
            renderMonthlyTable();
            updateDashboard();
            updateTaxDashboard();
        });

        // Render income entries
        function renderIncome() {
            const list = document.getElementById('incomeList');
            const sortedIncome = [...data.income].sort((a, b) => new Date(b.date) - new Date(a.date));
            const currentMonthStr = new Date().toISOString().slice(0, 7);
            const monthTotal = data.income
                .filter(inc => inc.date.startsWith(currentMonthStr))
                .reduce((sum, inc) => sum + inc.amount, 0);

            document.getElementById('incomeMonthTotal').textContent = `¬£${monthTotal.toFixed(2)}`;

            if (sortedIncome.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #a0a0a0; padding: 20px;">No income entries yet</p>';
                return;
            }

            list.innerHTML = sortedIncome.map(inc => `
                <div class="entry-item">
                    <div class="entry-header">
                        <div>
                            <div class="entry-amount">¬£${inc.amount.toFixed(2)}</div>
                            <div class="entry-details">
                                ${new Date(inc.date).toLocaleDateString('en-GB')} ‚Ä¢ ${inc.source}
                            </div>
                        </div>
                        <button class="delete-btn" onclick="deleteIncome(${inc.id})">Delete</button>
                    </div>
                    <div class="entry-details">
                        ${inc.description}
                    </div>
                    <div class="entry-details" style="margin-top: 8px;">
                        Tax (${data.settings.taxRate}%): ¬£${inc.tax.toFixed(2)} ‚Ä¢ Net: ¬£${inc.net.toFixed(2)}
                    </div>
                </div>
            `).join('');
        }

        // Delete income
        function deleteIncome(id) {
            if (confirm('Delete this income entry?')) {
                data.income = data.income.filter(inc => inc.id !== id);
                saveData();
                renderIncome();
                renderMonthlyTable();
                updateDashboard();
                updateTaxDashboard();
            }
        }

        // Expense form submission
        document.getElementById('expenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const receiptFile = document.getElementById('expenseReceipt').files[0];
            let receiptData = null;

            if (receiptFile) {
                receiptData = await fileToBase64(receiptFile);
            }

            const expense = {
                id: Date.now(),
                date: document.getElementById('expenseDate').value,
                description: document.getElementById('expenseDescription').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                category: document.getElementById('expenseCategory').value,
                receipt: receiptData
            };

            data.expenses.push(expense);
            saveData();

            e.target.reset();
            setDefaultDates();
            renderExpenses();
            renderMonthlyTable();
            updateDashboard();
            updateTaxDashboard();
        });

        // File to base64 helper
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Render expense entries
        function renderExpenses() {
            const list = document.getElementById('expenseList');
            const sortedExpenses = [...data.expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            const currentMonthStr = new Date().toISOString().slice(0, 7);
            const monthTotal = data.expenses
                .filter(exp => exp.date.startsWith(currentMonthStr) && exp.category !== 'Living')
                .reduce((sum, exp) => sum + exp.amount, 0);

            document.getElementById('expenseMonthTotal').textContent = `¬£${monthTotal.toFixed(2)}`;

            if (sortedExpenses.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #a0a0a0; padding: 20px;">No expense entries yet</p>';
                return;
            }

            list.innerHTML = sortedExpenses.map(exp => `
                <div class="entry-item" style="border-left-color: #ff4444;">
                    <div class="entry-header">
                        <div>
                            <div class="entry-amount" style="color: #ff4444;">-¬£${exp.amount.toFixed(2)}</div>
                            <div class="entry-details">
                                ${new Date(exp.date).toLocaleDateString('en-GB')} ‚Ä¢ ${exp.category}
                            </div>
                        </div>
                        <button class="delete-btn" onclick="deleteExpense(${exp.id})">Delete</button>
                    </div>
                    <div class="entry-details">
                        ${exp.description}
                    </div>
                    ${exp.receipt ? `
                        <div class="entry-details" style="margin-top: 8px;">
                            <span class="receipt-link" onclick="viewReceipt(${exp.id})">üìé View Receipt</span>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Delete expense
        function deleteExpense(id) {
            if (confirm('Delete this expense entry?')) {
                data.expenses = data.expenses.filter(exp => exp.id !== id);
                saveData();
                renderExpenses();
                renderMonthlyTable();
                updateDashboard();
                updateTaxDashboard();
            }
        }

        // View receipt in new window
        function viewReceipt(id) {
            const expense = data.expenses.find(exp => exp.id === id);
            if (expense && expense.receipt) {
                const win = window.open();
                win.document.write(`<img src="${expense.receipt}" style="max-width: 100%;">`);
            }
        }

        // Update top dashboard stats
        function updateDashboard() {
            const monthlyData = calculateMonthlyData();
            const today = new Date().toISOString().slice(0, 7);
            const currentMonth = monthlyData.find(m => m.date === today) || monthlyData[monthlyData.length - 1];

            document.getElementById('currentBalance').textContent = `¬£${currentMonth.closingBalance.toFixed(2)}`;
            document.getElementById('monthIncome').textContent = `¬£${currentMonth.income.toFixed(2)}`;

            const ytdIncome = data.income.reduce((sum, inc) => sum + inc.amount, 0);
            document.getElementById('ytdIncome').textContent = `¬£${ytdIncome.toFixed(2)}`;

            const taxReserve = data.income.reduce((sum, inc) => sum + inc.tax, 0);
            document.getElementById('taxReserve').textContent = `¬£${taxReserve.toFixed(2)}`;
        }

        // Tax calculation based on UK bands 2025/26
        function calculateTaxOwed(profit) {
            let tax = 0;

            if (profit <= 12570) {
                tax = 0;
            } else if (profit <= 50270) {
                tax = (profit - 12570) * 0.20;
            } else if (profit <= 125140) {
                tax = (50270 - 12570) * 0.20 + (profit - 50270) * 0.40;
            } else {
                tax = (50270 - 12570) * 0.20 +
                      (125140 - 50270) * 0.40 +
                      (profit - 125140) * 0.45;
            }

            return tax;
        }

        // Update tax dashboard (tax year 6 Apr 2025 - 5 Apr 2026)
        function updateTaxDashboard() {
            const taxYearStart = new Date('2025-04-06');
            const taxYearEnd = new Date('2026-04-05');

            const ytdIncome = data.income
                .filter(inc => {
                    const incDate = new Date(inc.date);
                    return incDate >= taxYearStart && incDate <= taxYearEnd;
                })
                .reduce((sum, inc) => sum + inc.amount, 0);

            const ytdExpenses = data.expenses
                .filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate >= taxYearStart && expDate <= taxYearEnd && exp.category !== 'Living';
                })
                .reduce((sum, exp) => sum + exp.amount, 0);

            const taxableProfit = ytdIncome - ytdExpenses;
            const estimatedTax = taxableProfit > 0 ? calculateTaxOwed(taxableProfit) : 0;
            const taxSetAside = ytdIncome * (data.settings.taxRate / 100);
            const taxDifference = taxSetAside - estimatedTax;

            document.getElementById('taxTotalIncome').textContent = `¬£${ytdIncome.toFixed(2)}`;
            document.getElementById('taxTotalExpenses').textContent = `¬£${ytdExpenses.toFixed(2)}`;
            document.getElementById('taxableProfit').textContent = `¬£${taxableProfit.toFixed(2)}`;
            document.getElementById('estimatedTax').textContent = `¬£${estimatedTax.toFixed(2)}`;
            document.getElementById('taxSetAside').textContent = `¬£${taxSetAside.toFixed(2)}`;

            const diffElement = document.getElementById('taxDifference');
            diffElement.textContent = `¬£${Math.abs(taxDifference).toFixed(2)}`;
            diffElement.className = taxDifference >= 0 ? 'amount positive' : 'amount negative';
        }

        // Tab switching
        function switchTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const tab = document.getElementById(tabName);
            if (tab) tab.classList.add('active');

            if (evt && evt.target) {
                evt.target.classList.add('active');
            }
        }

        // Save settings
        function saveSettings() {
            data.settings.safetyThreshold = parseFloat(document.getElementById('safetyThreshold').value);
            data.settings.livingCosts = parseFloat(document.getElementById('livingCosts').value);
            data.settings.taxRate = parseFloat(document.getElementById('taxRate').value);

            // Recalculate tax for all income entries based on new tax rate
            data.income = data.income.map(inc => ({
                ...inc,
                tax: inc.amount * (data.settings.taxRate / 100),
                net: inc.amount * (1 - data.settings.taxRate / 100)
            }));

            document.getElementById('subtitleText').textContent =
                `Freelance Music Production Business | Safety Threshold: ¬£${(data.settings.safetyThreshold || 20000).toLocaleString()}`;

            saveData();
            renderMonthlyTable();
            renderIncome();
            updateDashboard();
            updateTaxDashboard();
            alert('Settings saved successfully!');
        }

        // Export data as JSON (includes receipts)
        function exportData() {
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `accounting-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Export CSV (for accountant/HMRC)
        function exportCSV() {
            let csv = 'Type,Date,Description,Amount,Category/Source,Tax,Net\n';

            data.income.forEach(inc => {
                csv += `Income,${inc.date},"${inc.description.replace(/"/g, '""')}",${inc.amount},${inc.source},${inc.tax},${inc.net}\n`;
            });

            data.expenses.forEach(exp => {
                csv += `Expense,${exp.date},"${exp.description.replace(/"/g, '""')}",${exp.amount},${exp.category},,\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `accounting-export-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Import JSON data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (confirm('This will replace all current data. Continue?')) {
                        data = imported;
                        saveData();
                        init();
                        alert('Data imported successfully!');
                    }
                } catch (err) {
                    alert('Error importing data: Invalid file format');
                }
            };
            reader.readAsText(file);
        }

        // Clear all data
        function clearAllData() {
            if (confirm('This will delete ALL data permanently. Are you sure?')) {
                if (confirm('Really sure? This cannot be undone!')) {
                    localStorage.removeItem('accountingData');
                    location.reload();
                }
            }
        }

        // Run init when page is fully loaded
        window.addEventListener('load', init);
    </script>
</body>
</html>
